INSERT INTO dim_product_base
SELECT
p.product_id,
concat('商品', p.product_id) AS product_name,
-- 随机叶子类目（模拟服饰、电子等细分类目）
case floor(rand()*3)
when 0 then '服饰-男装-T恤'
when 1 then '电子-手机-智能手机'
else '家居-厨具-炒锅'
end AS category_leaf,
-- 随机价格（10-999元）
round(rand()*989 + 10, 2) AS price
FROM tmp_product_ids p;
--  商品访问行为表（fact_product_visit）

CREATE TABLE fact_product_visit (
product_id string COMMENT '商品ID',
visitor_count bigint COMMENT '商品访客数',
view_count bigint COMMENT '商品浏览量',
avg_stay_time int COMMENT '平均停留时长（秒）',
bounce_rate double COMMENT '详情页跳出率',
micro_detail_visitor_count bigint COMMENT '微详情访客数'
)
COMMENT '商品访问行为表'
PARTITIONED BY (stat_period string COMMENT '统计周期（日/周/月）')
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');

INSERT INTO fact_product_visit PARTITION (stat_period)
SELECT
p.product_id,
-- 访客数（50-500人，去重）
floor(rand()*450 + 50) AS visitor_count,
-- 浏览量（访客数1-3倍）
floor(visitor_count * (rand()*2 + 1)) AS view_count,
-- 平均停留时长（10-180秒）
floor(rand()*170 + 10) AS avg_stay_time,
-- 跳出率（0.1-0.7）
round(rand()*0.6 + 0.1, 2) AS bounce_rate,
-- 微详情访客数（浏览≥3秒，占总访客30%-60%）
floor(visitor_count * (rand()*0.3 + 0.3)) AS micro_detail_visitor_count,
d.stat_period
FROM tmp_product_ids p
CROSS JOIN tmp_dates d;

-- 商品收藏加购表（fact_product_collect_cart）
CREATE TABLE fact_product_collect_cart (
product_id string COMMENT '商品ID',
collect_user_count bigint COMMENT '收藏人数',
add_cart_user_count bigint COMMENT '加购人数',
add_cart_item_count bigint COMMENT '加购件数',
visit_collect_conv_rate double COMMENT '访问收藏转化率',
visit_add_cart_conv_rate double COMMENT '访问加购转化率'
)
COMMENT '商品收藏加购表'
PARTITIONED BY (stat_period string COMMENT '统计周期（日/周/月）')
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');


INSERT INTO fact_product_collect_cart PARTITION (stat_period)
SELECT
p.product_id,
-- 收藏人数（访客数5%-20%）
floor(v.visitor_count * (rand()*0.15 + 0.05)) AS collect_user_count,
-- 加购人数（访客数10%-30%）
floor(v.visitor_count * (rand()*0.2 + 0.1)) AS add_cart_user_count,
-- 加购件数（加购人数1-2倍）
floor(add_cart_user_count * (rand() + 1)) AS add_cart_item_count,
-- 访问收藏转化率（收藏人数/访客数）
round(collect_user_count / v.visitor_count, 4) AS visit_collect_conv_rate,
-- 访问加购转化率（加购人数/访客数）
round(add_cart_user_count / v.visitor_count, 4) AS visit_add_cart_conv_rate,
d.stat_period
FROM tmp_product_ids p
CROSS JOIN tmp_dates d
-- 关联访问表获取访客数用于计算
LEFT JOIN fact_product_visit v
ON p.product_id = v.product_id AND d.stat_period = v.stat_period;

-- 商品下单支付表（fact_product_pay）

CREATE TABLE fact_product_pay (
product_id string COMMENT '商品ID',
order_user_count bigint COMMENT '下单买家数',
order_item_count bigint COMMENT '下单件数',
order_amount decimal(12,2) COMMENT '下单金额',
order_conv_rate double COMMENT '下单转化率',
pay_user_count bigint COMMENT '支付买家数',
pay_item_count bigint COMMENT '支付件数',
pay_amount decimal(12,2) COMMENT '支付金额',
pay_conv_rate double COMMENT '支付转化率',
new_pay_user_count bigint COMMENT '支付新买家数',
old_pay_user_count bigint COMMENT '支付老买家数',
old_user_pay_amount decimal(12,2) COMMENT '老买家支付金额',
per_user_price decimal(10,2) COMMENT '客单价',
refund_amount decimal(12,2) COMMENT '成功退款退货金额',
juhuasuan_pay_amount decimal(12,2) COMMENT '聚划算支付金额',
annual_cumulative_pay decimal(12,2) COMMENT '年累计支付金额',
visitor_avg_value decimal(10,2) COMMENT '访客平均价值'
)
COMMENT '商品下单支付表'
PARTITIONED BY (stat_period string COMMENT '统计周期（日/周/月）')

STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');


INSERT INTO fact_product_pay PARTITION (stat_period)
SELECT
p.product_id,
-- 下单买家数（加购人数20%-50%）
floor(c.add_cart_user_count * (rand()*0.3 + 0.2)) AS order_user_count,
-- 下单件数（下单人数1-3倍）
floor(order_user_count * (rand()*2 + 1)) AS order_item_count,
-- 下单金额（下单件数*商品价格*0.8-1.2倍）
round(order_item_count * b.price * (rand()*0.4 + 0.8), 2) AS order_amount,
-- 下单转化率（下单人数/访客数）
round(order_user_count / v.visitor_count, 4) AS order_conv_rate,
-- 支付买家数（下单人数60%-90%）
floor(order_user_count * (rand()*0.3 + 0.6)) AS pay_user_count,
-- 支付件数（支付人数1-2.5倍）
floor(pay_user_count * (rand()*1.5 + 1)) AS pay_item_count,
-- 支付金额（支付件数*商品价格*0.8-1.2倍）
round(pay_item_count * b.price * (rand()*0.4 + 0.8), 2) AS pay_amount,
-- 支付转化率（支付人数/访客数）
round(pay_user_count / v.visitor_count, 4) AS pay_conv_rate,
-- 新买家数（支付人数30%-70%）
floor(pay_user_count * (rand()*0.4 + 0.3)) AS new_pay_user_count,
-- 老买家数（支付人数-新买家数）
pay_user_count - new_pay_user_count AS old_pay_user_count,
-- 老买家支付金额（老买家数占比*支付金额）
round(pay_amount * (old_pay_user_count / pay_user_count), 2) AS old_user_pay_amount,
-- 客单价（支付金额/支付人数）
round(pay_amount / pay_user_count, 2) AS per_user_price,
-- 退款金额（支付金额0-5%）
round(pay_amount * rand()*0.05, 2) AS refund_amount,
-- 聚划算支付金额（支付金额0-30%）
round(pay_amount * rand()*0.3, 2) AS juhuasuan_pay_amount,
-- 年累计支付金额（1-12倍当日支付金额）
round(pay_amount * (rand()*11 + 1), 2) AS annual_cumulative_pay,
-- 访客平均价值（支付金额/访客数）
round(pay_amount / v.visitor_count, 2) AS visitor_avg_value,
d.stat_period
FROM tmp_product_ids p
CROSS JOIN tmp_dates d
-- 关联基础表获取价格
LEFT JOIN dim_product_base b ON p.product_id = b.product_id
-- 关联访问表获取访客数
LEFT JOIN fact_product_visit v ON p.product_id = v.product_id AND d.stat_period = v.stat_period
-- 关联收藏加购表获取加购人数
LEFT JOIN fact_product_collect_cart c ON p.product_id = c.product_id AND d.stat_period = c.stat_period;

-- 商品竞争力评分表（fact_product_competitiveness）
CREATE TABLE fact_product_competitiveness (
product_id string COMMENT '商品ID',
competitiveness_score int COMMENT '竞争力评分'
)
COMMENT '商品竞争力评分表'
PARTITIONED BY (stat_period string COMMENT '统计周期（日/周/月）')

STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');

INSERT INTO fact_product_competitiveness PARTITION (stat_period)
SELECT
p.product_id,
-- 竞争力评分（50-95分，综合流量、转化等能力）
floor(rand()*45 + 50) AS competitiveness_score,
d.stat_period
FROM tmp_product_ids p
CROSS JOIN tmp_dates d;