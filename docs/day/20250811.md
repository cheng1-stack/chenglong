create database if not exists new01;
use new01;
-- 禁用统计信息收集相关的参数
SET hive.stats.autogather=false;
SET hive.stats.column.autogather=false;
SET hive.stats.fetch.column.stats=false;
SET hive.stats.fetch.partition.stats=false;

-- 调整执行引擎相关参数
SET hive.exec.compress.output=false;
SET hive.exec.dynamic.partition.mode=nonstrict;
SET hive.tez.container.size=1024;
SET hive.tez.java.opts=-Xmx8192m;

-- 其他可能有用的参数
SET hive.optimize.sort.dynamic.partition=false;
SET hive.mapred.mode=nonstrict;
SET hive.exec.dynamic.partition.mode=nonstrict;
-- 定义动态日期变量（可通过--hivevar或SET覆盖）
SET hiveconf:stat_dt=2025-08-13;

-- 商品基础信息表（无终端维度，保持不变）

CREATE TABLE IF NOT EXISTS ods_product_base (
product_id STRING COMMENT '商品ID（唯一标识）',
product_name STRING COMMENT '商品名称',
category_leaf STRING COMMENT '叶子类目（如：服饰-男装-T恤）',
price DECIMAL(10,2) COMMENT '商品价格（元）',
create_time STRING COMMENT '商品创建时间（yyyy-MM-dd）'
)
COMMENT 'ODS层-商品基础信息表'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/ods_product_base/'
TBLPROPERTIES ('orc.compress' = 'SNAPPY');

-- 2. 商品访问行为表（新增 PC / 无线端字段）

CREATE TABLE IF NOT EXISTS ods_product_visit (
product_id STRING COMMENT '商品ID',
stat_period STRING COMMENT '统计周期（与dt一致）',
-- 终端细分指标
pc_visitor_count INT COMMENT 'PC端访客数（去重）',
wireless_visitor_count INT COMMENT '无线端访客数（去重）',
pc_view_count INT COMMENT 'PC端浏览量',
wireless_view_count INT COMMENT '无线端浏览量',
pc_avg_stay_time INT COMMENT 'PC端平均停留时长（秒）',
wireless_avg_stay_time INT COMMENT '无线端平均停留时长（秒）',
pc_bounce_rate DECIMAL(3,2) COMMENT 'PC端跳出率',
wireless_bounce_rate DECIMAL(3,2) COMMENT '无线端跳出率',
-- 总指标（依据文件：所有终端访客数为PC+无线去重总和）
total_visitor_count INT COMMENT '总访客数（PC+无线去重）',
total_view_count INT COMMENT '总浏览量（PC+无线）'
)
COMMENT 'ODS层-商品访问行为表（含终端细分）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/ods_product_visit/'
TBLPROPERTIES ('orc.compress' = 'SNAPPY');

-- 3. 商品收藏加购表（新增 PC / 无线端字段）
CREATE TABLE IF NOT EXISTS ods_product_collect_cart (
product_id STRING COMMENT '商品ID',
stat_period STRING COMMENT '统计周期',
-- 终端细分指标
pc_collect_user_count INT COMMENT 'PC端收藏人数',
wireless_collect_user_count INT COMMENT '无线端收藏人数',
pc_add_cart_user_count INT COMMENT 'PC端加购人数',
wireless_add_cart_user_count INT COMMENT '无线端加购人数',
pc_add_cart_item_count INT COMMENT 'PC端加购件数',
wireless_add_cart_item_count INT COMMENT '无线端加购件数',
-- 总指标
total_collect_user_count INT COMMENT '总收藏人数',
total_add_cart_user_count INT COMMENT '总加购人数',
total_add_cart_item_count INT COMMENT '总加购件数'
)
COMMENT 'ODS层-商品收藏加购表（含终端细分）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/ods_product_collect_cart/'
TBLPROPERTIES ('orc.compress' = 'SNAPPY');

INSERT INTO TABLE ods_product_collect_cart PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
t2.product_id,  -- 明确指定使用t2子查询中的product_id
'${hiveconf:stat_dt}' AS stat_period,
-- PC端收藏人数（PC访客数的5%~15% ，基于ods_product_visit的pc_visitor_count计算）
CAST(pc_visitor * (RAND() * 0.1 + 0.05) AS INT) AS pc_collect_user_count,
-- 无线端收藏人数（无线访客数的8%~20% ，基于ods_product_visit的wireless_visitor_count计算）
CAST(wireless_visitor * (RAND() * 0.12 + 0.08) AS INT) AS wireless_collect_user_count,
-- PC端加购人数（PC访客数的10%~25% ，基于ods_product_visit的pc_visitor_count计算）
CAST(pc_visitor * (RAND() * 0.15 + 0.1) AS INT) AS pc_add_cart_user_count,
-- 无线端加购人数（无线访客数的15%~30% ，基于ods_product_visit的wireless_visitor_count计算）
CAST(wireless_visitor * (RAND() * 0.15 + 0.15) AS INT) AS wireless_add_cart_user_count,
-- PC端加购件数（PC加购人数的1~2倍 ）
CAST((CAST(pc_visitor * (RAND() * 0.15 + 0.1) AS INT)) * (RAND() + 1) AS INT) AS pc_add_cart_item_count,
-- 无线端加购件数（无线加购人数的1~3倍 ）
CAST((CAST(wireless_visitor * (RAND() * 0.15 + 0.15) AS INT)) * (RAND() * 2 + 1) AS INT) AS wireless_add_cart_item_count,
-- 总收藏人数（PC端收藏人数 + 无线端收藏人数 ）
(CAST(pc_visitor * (RAND() * 0.1 + 0.05) AS INT)) + (CAST(wireless_visitor * (RAND() * 0.12 + 0.08) AS INT)) AS total_collect_user_count,
-- 总加购人数（PC端加购人数 + 无线端加购人数 ）
(CAST(pc_visitor * (RAND() * 0.15 + 0.1) AS INT)) + (CAST(wireless_visitor * (RAND() * 0.15 + 0.15) AS INT)) AS total_add_cart_user_count,
-- 总加购件数（PC端加购件数 + 无线端加购件数 ）
(CAST((CAST(pc_visitor * (RAND() * 0.15 + 0.1) AS INT)) * (RAND() + 1) AS INT)) + (CAST((CAST(wireless_visitor * (RAND() * 0.15 + 0.15) AS INT)) * (RAND() * 2 + 1) AS INT)) AS total_add_cart_item_count
FROM (
-- 从ods_product_visit表获取终端访客数，同时关联生成商品ID的辅助表，确保数据量匹配
SELECT
t1.product_id,  -- 明确指定使用t1的product_id
pv.pc_visitor_count AS pc_visitor,
pv.wireless_visitor_count AS wireless_visitor,
t1.pos
FROM (
SELECT
pos,
CONCAT('P', LPAD(CAST(pos + 1 AS STRING), 5, '0')) AS product_id
FROM (SELECT posexplode(split(space(9999), ' ')) AS (pos, val)) t
) t1
JOIN ods_product_visit pv
ON t1.product_id = pv.product_id
AND pv.dt = '${hiveconf:stat_dt}'
) t2;




-- 商品下单支付表（新增 PC / 无线端字段）

CREATE TABLE IF NOT EXISTS ods_product_trade (
product_id STRING COMMENT '商品ID',
stat_period STRING COMMENT '统计周期',
-- 终端细分指标（依据文件：拍下终端决定统计口径）
pc_order_user_count INT COMMENT 'PC端下单买家数',
wireless_order_user_count INT COMMENT '无线端下单买家数',
pc_pay_user_count INT COMMENT 'PC端支付买家数',
wireless_pay_user_count INT COMMENT '无线端支付买家数',
pc_pay_amount DECIMAL(10,2) COMMENT 'PC端支付金额',
wireless_pay_amount DECIMAL(10,2) COMMENT '无线端支付金额',
pc_refund_amount DECIMAL(10,2) COMMENT 'PC端退款金额',
wireless_refund_amount DECIMAL(10,2) COMMENT '无线端退款金额',
-- 总指标
total_order_user_count INT COMMENT '总下单买家数（PC+无线去重）',
total_pay_user_count INT COMMENT '总支付买家数（PC+无线去重）',
total_pay_amount DECIMAL(10,2) COMMENT '总支付金额',
total_refund_amount DECIMAL(10,2) COMMENT '总退款金额',
-- 其他指标（保留）
pay_new_user_count INT COMMENT '支付新买家数',
pay_old_user_count INT COMMENT '支付老买家数'
)
COMMENT 'ODS层-商品下单支付表（含终端细分）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/ods_product_trade/'
TBLPROPERTIES ('orc.compress' = 'SNAPPY');

INSERT INTO TABLE ods_product_trade PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
t2.product_id,  -- 明确指定使用t2的product_id
'${hiveconf:stat_dt}' AS stat_period,
-- PC端下单人数（PC加购人数的30%~50%）
CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT) AS pc_order_user_count,
-- 无线端下单人数（无线加购人数的40%~60%）
CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT) AS wireless_order_user_count,
-- PC端支付人数（PC下单人数的70%~90%）
CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT) AS pc_pay_user_count,
-- 无线端支付人数（无线下单人数的60%~80%）
CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT) AS wireless_pay_user_count,
-- PC端支付金额（PC支付人数 * 商品单价 * 1~2件）
ROUND((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) * price * (RAND() + 1), 2) AS pc_pay_amount,
-- 无线端支付金额（无线支付人数 * 商品单价 * 1~2件）
ROUND((CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT)) * price * (RAND() + 1), 2) AS wireless_pay_amount,
-- 终端退款金额（支付金额的0~5%）
ROUND((ROUND((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) * price * (RAND() + 1), 2)) * RAND() * 0.05, 2) AS pc_refund_amount,
ROUND((ROUND((CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT)) * price * (RAND() + 1), 2)) * RAND() * 0.05, 2) AS wireless_refund_amount,
-- 总指标（终端求和/去重）
(CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) + (CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) AS total_order_user_count,
(CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) + (CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT)) AS total_pay_user_count,
(ROUND((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) * price * (RAND() + 1), 2)) +
(ROUND((CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT)) * price * (RAND() + 1), 2)) AS total_pay_amount,
(ROUND((ROUND((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) * price * (RAND() + 1), 2)) * RAND() * 0.05, 2)) + (ROUND((ROUND((CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT)) * price * (RAND() + 1), 2)) * RAND() * 0.05, 2)) AS total_refund_amount,
-- 新买家数（支付人数的30%~50%）
CAST(((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) + (CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT))) * (RAND() * 0.2 + 0.3) AS INT) AS pay_new_user_count,
-- 老买家数（总支付 - 新买家）
((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) + (CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT))) - (CAST(((CAST((CAST(pc_add_cart * (RAND() * 0.2 + 0.3) AS INT)) * (RAND() * 0.2 + 0.7) AS INT)) + (CAST((CAST(wireless_add_cart * (RAND() * 0.2 + 0.4) AS INT)) * (RAND() * 0.2 + 0.6) AS INT))) * (RAND() * 0.2 + 0.3) AS INT)) AS pay_old_user_count
FROM (
-- 从加购表获取终端加购人数
SELECT
pcc.product_id,  -- 明确指定字段来源
pcc.pc_add_cart_user_count AS pc_add_cart,
pcc.wireless_add_cart_user_count AS wireless_add_cart
FROM ods_product_collect_cart pcc
WHERE pcc.dt = '${hiveconf:stat_dt}'
) t1
-- 关联基础表获取商品价格
JOIN ods_product_base pb
ON t1.product_id = pb.product_id
AND pb.dt = '${hiveconf:stat_dt}'
-- 关联序号表确保10000条数据
JOIN (
SELECT CONCAT('P', LPAD(CAST(pos + 1 AS STRING), 5, '0')) AS product_id, pos
FROM (SELECT posexplode(split(space(9999), ' ')) AS (pos, val)) t
) t2 ON t1.product_id = t2.product_id;




INSERT INTO TABLE ods_product_base PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
CONCAT('P', LPAD(CAST(pos + 1 AS STRING), 5, '0')) AS product_id,
CONCAT('商品', LPAD(CAST(pos + 1 AS STRING), 5, '0')) AS product_name,
CASE CAST(RAND() * 4 AS INT)
WHEN 0 THEN '服饰-男装-T恤'
WHEN 1 THEN '电子-手机-智能手机'
WHEN 2 THEN '家居-厨具-炒锅'
ELSE '美妆-护肤-面霜'
END AS category_leaf,
ROUND(RAND() * 990 + 10, 2) AS price,
DATE_FORMAT(DATE_ADD('${hiveconf:stat_dt}', -CAST(RAND() * 365 AS INT)), 'yyyy-MM-dd') AS create_time
FROM (
SELECT pos FROM (SELECT posexplode(split(space(9999), ' ')) AS (pos, val)) t
) t;

INSERT INTO TABLE ods_product_visit PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
CONCAT('P', LPAD(CAST(pos + 1 AS STRING), 5, '0')) AS product_id,
'${hiveconf:stat_dt}' AS stat_period,
-- PC端访客（总访客的20%~40%）
CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT) AS pc_visitor_count,
-- 无线端访客（总访客 - PC端，模拟去重）
total_visitor - (CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT)) AS wireless_visitor_count,
-- PC端浏览量（PC访客的1~3倍）
CAST((CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT)) * (RAND() * 2 + 1) AS INT) AS pc_view_count,
-- 无线端浏览量（无线访客的1~4倍）
CAST((total_visitor - (CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT))) * (RAND() * 3 + 1) AS INT) AS wireless_view_count,
CAST(RAND() * 200 + 30 AS INT) AS pc_avg_stay_time,  -- PC端停留更长
CAST(RAND() * 150 + 10 AS INT) AS wireless_avg_stay_time,  -- 无线端停留较短
ROUND(RAND() * 0.4 + 0.1, 2) AS pc_bounce_rate,  -- PC端跳出率更低
ROUND(RAND() * 0.5 + 0.2, 2) AS wireless_bounce_rate,  -- 无线端跳出率略高
total_visitor AS total_visitor_count,
(CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT)) + (CAST((total_visitor - (CAST(total_visitor * (RAND() * 0.2 + 0.2) AS INT))) * (RAND() * 3 + 1) AS INT)) AS total_view_count
FROM (
SELECT pos, CAST(RAND() * 950 + 50 AS INT) AS total_visitor  -- 总访客50~1000
FROM (SELECT posexplode(split(space(9999), ' ')) AS (pos, val)) t
) t;

CREATE TABLE IF NOT EXISTS dwd_product_visit_detail (
product_id STRING COMMENT '商品ID',
product_name STRING COMMENT '商品名称',
category_leaf STRING COMMENT '叶子类目',
stat_period STRING COMMENT '统计周期',
-- 终端指标
pc_visitor_count INT,
wireless_visitor_count INT,
pc_view_count INT,
wireless_view_count INT,
pc_avg_stay_time INT,
wireless_avg_stay_time INT,
pc_bounce_rate DECIMAL(3,2),
wireless_bounce_rate DECIMAL(3,2),
-- 总指标
total_visitor_count INT,
total_view_count INT
)
COMMENT 'DWD层-商品访问明细（含终端）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/dwd_product_visit_detail/';

-- 插入数据（关联基础表与访问表）
-- 商品访问明细宽表
INSERT INTO TABLE dwd_product_visit_detail PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
pv.product_id,
pb.product_name,
pb.category_leaf,
pv.stat_period,
pv.pc_visitor_count,
pv.wireless_visitor_count,
pv.pc_view_count,
pv.wireless_view_count,
pv.pc_avg_stay_time,
pv.wireless_avg_stay_time,
pv.pc_bounce_rate,
pv.wireless_bounce_rate,
pv.total_visitor_count,
pv.total_view_count
FROM ods_product_visit pv
JOIN ods_product_base pb
ON pv.product_id = pb.product_id
AND pv.dt = pb.dt  -- 关联动态分区
WHERE pv.dt = '${hiveconf:stat_dt}';

-- 1. 商品收藏加购明细宽表（DWD 层）

CREATE TABLE IF NOT EXISTS dwd_product_collect_cart_detail (
product_id STRING COMMENT '商品ID',
product_name STRING COMMENT '商品名称',
category_leaf STRING COMMENT '叶子类目',
stat_period STRING COMMENT '统计周期',
-- 终端细分指标
pc_collect_user_count INT COMMENT 'PC端收藏人数',
wireless_collect_user_count INT COMMENT '无线端收藏人数',
pc_add_cart_user_count INT COMMENT 'PC端加购人数',
wireless_add_cart_user_count INT COMMENT '无线端加购人数',
pc_add_cart_item_count INT COMMENT 'PC端加购件数',
wireless_add_cart_item_count INT COMMENT '无线端加购件数',
-- 总指标
total_collect_user_count INT COMMENT '总收藏人数',
total_add_cart_user_count INT COMMENT '总加购人数',
total_add_cart_item_count INT COMMENT '总加购件数'
)
COMMENT 'DWD层-商品收藏加购明细（含终端）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/dwd_product_collect_cart_detail/';


INSERT INTO TABLE dwd_product_collect_cart_detail PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
pcc.product_id,
pb.product_name,  -- 来自基础表
pb.category_leaf,  -- 来自基础表
pcc.stat_period,
pcc.pc_collect_user_count,
pcc.wireless_collect_user_count,
pcc.pc_add_cart_user_count,
pcc.wireless_add_cart_user_count,
pcc.pc_add_cart_item_count,
pcc.wireless_add_cart_item_count,
pcc.total_collect_user_count,
pcc.total_add_cart_user_count,
pcc.total_add_cart_item_count
FROM ods_product_collect_cart pcc
-- 关联商品基础表补充信息
JOIN ods_product_base pb
ON pcc.product_id = pb.product_id
AND pcc.dt = pb.dt
WHERE pcc.dt = '${hiveconf:stat_dt}';

-- 商品交易明细宽表（DWD 层）

CREATE TABLE IF NOT EXISTS dwd_product_trade_detail (
product_id STRING COMMENT '商品ID',
category_leaf STRING COMMENT '叶子类目',
stat_period STRING COMMENT '统计周期',
-- 终端交易指标
pc_order_user_count INT COMMENT 'PC端下单买家数',
wireless_order_user_count INT COMMENT '无线端下单买家数',
pc_pay_user_count INT COMMENT 'PC端支付买家数',
wireless_pay_user_count INT COMMENT '无线端支付买家数',
pc_pay_amount DECIMAL(10,2) COMMENT 'PC端支付金额',
wireless_pay_amount DECIMAL(10,2) COMMENT '无线端支付金额',
pc_refund_amount DECIMAL(10,2) COMMENT 'PC端退款金额',
wireless_refund_amount DECIMAL(10,2) COMMENT '无线端退款金额',
-- 总指标
total_order_user_count INT COMMENT '总下单买家数',
total_pay_user_count INT COMMENT '总支付买家数',
total_pay_amount DECIMAL(10,2) COMMENT '总支付金额',
total_refund_amount DECIMAL(10,2) COMMENT '总退款金额',
-- 用户分层指标
pay_new_user_count INT COMMENT '支付新买家数',
pay_old_user_count INT COMMENT '支付老买家数'
)
COMMENT 'DWD层-商品交易明细（含终端）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/dwd_product_trade_detail/';

INSERT INTO TABLE dwd_product_trade_detail PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
pt.product_id,
pb.category_leaf,  -- 来自基础表
pt.stat_period,
pt.pc_order_user_count,
pt.wireless_order_user_count,
pt.pc_pay_user_count,
pt.wireless_pay_user_count,
pt.pc_pay_amount,
pt.wireless_pay_amount,
pt.pc_refund_amount,
pt.wireless_refund_amount,
pt.total_order_user_count,
pt.total_pay_user_count,
pt.total_pay_amount,
pt.total_refund_amount,
pt.pay_new_user_count,
pt.pay_old_user_count
FROM ods_product_trade pt
-- 关联商品基础表补充类目
JOIN ods_product_base pb
ON pt.product_id = pb.product_id
AND pt.dt = pb.dt
WHERE pt.dt = '${hiveconf:stat_dt}';



CREATE TABLE IF NOT EXISTS dws_product_sale_summary (
product_id STRING,
product_name STRING,
category_leaf STRING,
stat_dt STRING,
-- 终端支付指标
pc_pay_amount DECIMAL(10,2),
wireless_pay_amount DECIMAL(10,2),
pc_pay_ratio DECIMAL(3,2) COMMENT 'PC端支付占比',
-- 总指标
total_pay_amount DECIMAL(10,2),
total_visitor_count INT
)
COMMENT 'DWS层-商品销售汇总（含终端）'
PARTITIONED BY (dt STRING);

-- 插入数据（动态分区）
-- DWS 商品销售汇总表（含终端占比）
INSERT INTO TABLE dws_product_sale_summary PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
pt.product_id,
pb.product_name,
pb.category_leaf,
pt.stat_period,
pt.pc_pay_amount,
pt.wireless_pay_amount,
ROUND(pt.pc_pay_amount / NULLIF(pt.total_pay_amount, 0), 2) AS pc_pay_ratio,
pt.total_pay_amount,
pv.total_visitor_count
FROM ods_product_trade pt
JOIN ods_product_visit pv ON pt.product_id = pv.product_id AND pt.dt = pv.dt
JOIN ods_product_base pb ON pt.product_id = pb.product_id AND pt.dt = pb.dt
WHERE pt.dt = '${hiveconf:stat_dt}';

-- 3. 类目销售汇总表（DWS 层）

CREATE TABLE IF NOT EXISTS dws_category_sale_summary (
category_leaf STRING COMMENT '叶子类目',
stat_dt STRING COMMENT '统计日期',
-- 终端汇总指标
pc_total_pay_amount DECIMAL(10,2) COMMENT '类目PC端总支付金额',
wireless_total_pay_amount DECIMAL(10,2) COMMENT '类目无线端总支付金额',
-- 总指标
total_pay_amount DECIMAL(10,2) COMMENT '类目总支付金额',
total_product_cnt INT COMMENT '类目商品数',
avg_pay_amount DECIMAL(10,2) COMMENT '类目客单价'
)
COMMENT 'DWS层-类目销售汇总（含终端）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/dws_category_sale_summary/';

-- 替换原 INSERT 语句，用 COALESCE 处理空值
-- 替换原 INSERT 语句，用 COALESCE 处理空值
INSERT INTO TABLE dws_category_sale_summary PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
COALESCE(category_leaf, '未知类目') AS category_leaf,  -- 避免分组字段为空
COALESCE(stat_dt, '${hiveconf:stat_dt}') AS stat_dt,    -- 强制填充日期
SUM(pc_pay_amount) AS pc_total_pay_amount,
SUM(wireless_pay_amount) AS wireless_total_pay_amount,
SUM(total_pay_amount) AS total_pay_amount,
COUNT(DISTINCT product_id) AS total_product_cnt,
-- 使用 total_visitor_count 作为替代，或者根据业务逻辑调整
ROUND(SUM(total_pay_amount) / NULLIF(COUNT(DISTINCT product_id), 0), 2) AS avg_pay_amount
FROM dws_product_sale_summary
WHERE dt = '${hiveconf:stat_dt}'
GROUP BY
COALESCE(category_leaf, '未知类目'),
COALESCE(stat_dt, '${hiveconf:stat_dt}');





-- 修复后的 INSERT 语句（第427行附近）
INSERT INTO TABLE dws_product_sale_summary PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
pt.product_id,
pb.product_name,
pb.category_leaf,
pt.stat_period,
pt.pc_pay_amount,
pt.wireless_pay_amount,
ROUND(pt.pc_pay_amount / NULLIF(pt.total_pay_amount, 0), 2) AS pc_pay_ratio,
pt.total_pay_amount,
pv.total_visitor_count
FROM ods_product_trade pt
JOIN ods_product_visit pv ON pt.product_id = pv.product_id AND pt.dt = pv.dt
JOIN ods_product_base pb ON pt.product_id = pb.product_id AND pt.dt = pb.dt
WHERE pt.dt = '${hiveconf:stat_dt}';








CREATE TABLE IF NOT EXISTS ads_product_sale_rank (
product_id STRING,
product_name STRING,
category_leaf STRING,
stat_period STRING,
total_sales_rank INT,  -- 总销售额排名
pc_sales_rank INT,     -- PC端销售额排名
wireless_sales_rank INT  -- 无线端销售额排名
)
COMMENT 'ADS层-商品销售排行（含终端）'
PARTITIONED BY (dt STRING);

-- 插入数据（动态分区）
-- ADS 商品销售排行表（按终端维度）
INSERT INTO TABLE ads_product_sale_rank PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
product_id,
product_name,
category_leaf,
stat_dt,
RANK() OVER (PARTITION BY category_leaf ORDER BY total_pay_amount DESC) AS total_sales_rank,
RANK() OVER (PARTITION BY category_leaf ORDER BY pc_pay_amount DESC) AS pc_sales_rank,
RANK() OVER (PARTITION BY category_leaf ORDER BY wireless_pay_amount DESC) AS wireless_sales_rank
FROM dws_product_sale_summary
WHERE dt = '${hiveconf:stat_dt}';


-- 类目销售分析表（ADS 层）
CREATE TABLE IF NOT EXISTS ads_category_sale_analysis (
category_leaf STRING COMMENT '叶子类目',
stat_dt STRING COMMENT '统计日期',
wireless_pay_ratio DECIMAL(3,2) COMMENT '无线端支付占比',
total_pay_amount DECIMAL(10,2) COMMENT '类目总支付金额',
top_pc_product STRING COMMENT 'PC端销售额最高商品',
top_wireless_product STRING COMMENT '无线端销售额最高商品'
)
COMMENT 'ADS层-类目销售分析（含终端）'
PARTITIONED BY (dt STRING COMMENT '分区日期')
STORED AS ORC
LOCATION '/warehouse/macro/ads_category_sale_analysis/';

INSERT INTO TABLE ads_category_sale_analysis PARTITION (dt = '${hiveconf:stat_dt}')
SELECT
dws_category.category_leaf,
dws_category.stat_dt,
-- 无线端支付占比
ROUND(wireless_total_pay_amount / NULLIF(total_pay_amount, 0), 2) AS wireless_pay_ratio,
dws_category.total_pay_amount,
-- 类目PC端销售额最高商品
MAX(CASE WHEN ads_rank.pc_sales_rank = 1 THEN ads_rank.product_name END) AS top_pc_product,
-- 类目无线端销售额最高商品
MAX(CASE WHEN ads_rank.wireless_sales_rank = 1 THEN ads_rank.product_name END) AS top_wireless_product
FROM dws_category_sale_summary dws_category
-- 关联商品排行表获取Top商品
JOIN ads_product_sale_rank ads_rank
ON dws_category.category_leaf = ads_rank.category_leaf
AND dws_category.stat_dt = ads_rank.stat_period
WHERE dws_category.dt = '${hiveconf:stat_dt}'
GROUP BY
dws_category.category_leaf,
dws_category.stat_dt,
dws_category.total_pay_amount,
dws_category.wireless_total_pay_amount;
